#!/bin/bash
# Haploid Variant Calling (Single Sample, SNP-only)
# Author: Abaysew

# ------------------------------
# USER INPUT
# ------------------------------
SAMPLE="ERR15418593"
REF="ref_genome/ref.fasta"
VCF_DIR="variants"
mkdir -p "$VCF_DIR"
# ------------------------------

# ------------------------------
# FASTP BAM Variant Calling
# ------------------------------
FASTP_BAM="alignments/mtb/fastp/bam/${SAMPLE}.sorted.dedup.bam"

# Index BAM if needed
samtools index "$FASTP_BAM"

# Index reference if needed
samtools faidx "$REF"

# Call variants
bcftools mpileup -f "$REF" -q 20 -Q 20 -B -Ou "$FASTP_BAM" | \
bcftools call -mv -Ov --ploidy 1 -o "$VCF_DIR/${SAMPLE}.fastp.raw.vcf"

# Filter variants: QUAL>=30, DP>=10, only SNPs
bcftools view -v snps "$VCF_DIR/${SAMPLE}.fastp.raw.vcf" | \
bcftools filter -i 'QUAL>=30 && DP>=10' -Ov -o "$VCF_DIR/${SAMPLE}.fastp.filtered.snps.vcf"

# Compress and index
bgzip -c "$VCF_DIR/${SAMPLE}.fastp.filtered.snps.vcf" > "$VCF_DIR/${SAMPLE}.fastp.filtered.snps.vcf.gz"
bcftools index "$VCF_DIR/${SAMPLE}.fastp.filtered.snps.vcf.gz"

echo "FASTP SNP calling completed!"

# ------------------------------
# TRIMMOMATIC BAM Variant Calling
# ------------------------------
TRIM_BAM="alignments/mtb/trimmomatic/bam/${SAMPLE}.sorted.dedup.bam"

# Index BAM if needed
samtools index "$TRIM_BAM"

# Call variants
bcftools mpileup -f "$REF" -q 20 -Q 20 -B -Ou "$TRIM_BAM" | \
bcftools call -mv -Ov --ploidy 1 -o "$VCF_DIR/${SAMPLE}.trimmomatic.raw.vcf"

# Filter variants: QUAL>=30, DP>=10, only SNPs
bcftools view -v snps "$VCF_DIR/${SAMPLE}.trimmomatic.raw.vcf" | \
bcftools filter -i 'QUAL>=30 && DP>=10' -Ov -o "$VCF_DIR/${SAMPLE}.trimmomatic.filtered.snps.vcf"

# Compress and index
bgzip -c "$VCF_DIR/${SAMPLE}.trimmomatic.filtered.snps.vcf" > "$VCF_DIR/${SAMPLE}.trimmomatic.filtered.snps.vcf.gz"
bcftools index "$VCF_DIR/${SAMPLE}.trimmomatic.filtered.snps.vcf.gz"

echo "Trimmomatic SNP calling completed!"

# ------------------------------
# Compare SNP positions
# ------------------------------
ISec_DIR="$VCF_DIR/vcf_comparison"
mkdir -p "$ISec_DIR"

# Extract positions
bcftools query -f '%CHROM\t%POS\n' "$VCF_DIR/${SAMPLE}.fastp.filtered.snps.vcf.gz" | sort > "$ISec_DIR/fastp_pos.txt"
bcftools query -f '%CHROM\t%POS\n' "$VCF_DIR/${SAMPLE}.trimmomatic.filtered.snps.vcf.gz" | sort > "$ISec_DIR/trim_pos.txt"

# Shared and unique positions
comm -12 "$ISec_DIR/fastp_pos.txt" "$ISec_DIR/trim_pos.txt" > "$ISec_DIR/shared_positions.txt"
echo "Shared SNP positions: $(wc -l < "$ISec_DIR/shared_positions.txt")"
echo "FASTP unique SNPs: $(comm -23 "$ISec_DIR/fastp_pos.txt" "$ISec_DIR/trim_pos.txt" | wc -l)"
echo "Trimmomatic unique SNPs: $(comm -13 "$ISec_DIR/fastp_pos.txt" "$ISec_DIR/trim_pos.txt" | wc -l)"
