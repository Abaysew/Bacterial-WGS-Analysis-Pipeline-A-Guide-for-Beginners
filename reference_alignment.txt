#!/bin/bash
# Alignment, Sorting, Duplicate Marking Pipeline
# Author: Abaysew


# ------------------------------
# USER INPUT
# ------------------------------
SAMPLE="ERR15418593"              < input your analyses sample 
REF="ref_genome/ref.fasta"        < based on your own path 
THREADS=4
# ------------------------------

# Create BAM directories
mkdir -p alignments/mtb/fastp/bam
mkdir -p alignments/mtb/trimmomatic/bam

# ------------------------------
# Reference indexing
# ------------------------------
echo "Indexing reference..."
bwa index $REF

# ------------------------------
# FASTP ALIGNMENT
# ------------------------------
FASTP_R1="trimmed/mtb/fastp/${SAMPLE}_R1.trimmed.fastq.gz"
FASTP_R2="trimmed/mtb/fastp/${SAMPLE}_R2.trimmed.fastq.gz"
FASTP_BAM="alignments/mtb/fastp/bam/${SAMPLE}.sorted.dedup.bam"

echo "Aligning fastp-trimmed reads..."
bwa mem -t $THREADS $REF $FASTP_R1 $FASTP_R2 | samtools view -b - > alignments/mtb/fastp/bam/${SAMPLE}.bam

echo "Sorting fastp BAM..."
samtools sort -@ $THREADS -o alignments/mtb/fastp/bam/${SAMPLE}.sorted.bam alignments/mtb/fastp/bam/${SAMPLE}.bam

echo "Marking duplicates (fastp)..."
picard MarkDuplicates \
    I=alignments/mtb/fastp/bam/${SAMPLE}.sorted.bam \
    O=$FASTP_BAM \
    M=alignments/mtb/fastp/bam/${SAMPLE}_dup_metrics.txt \
    REMOVE_DUPLICATES=true

samtools index $FASTP_BAM

# ------------------------------
# TRIMMOMATIC ALIGNMENT
# ------------------------------
TRIM_R1="trimmed/mtb/trimmomatic/${SAMPLE}_R1_paired.fastq.gz"
TRIM_R2="trimmed/mtb/trimmomatic/${SAMPLE}_R2_paired.fastq.gz"
TRIM_BAM="alignments/mtb/trimmomatic/bam/${SAMPLE}.sorted.dedup.bam"

echo "Aligning Trimmomatic-trimmed reads..."
bwa mem -t $THREADS $REF $TRIM_R1 $TRIM_R2 | samtools view -b - > alignments/mtb/trimmomatic/bam/${SAMPLE}.bam

echo "Sorting Trimmomatic BAM..."
samtools sort -@ $THREADS -o alignments/mtb/trimmomatic/bam/${SAMPLE}.sorted.bam alignments/mtb/trimmomatic/bam/${SAMPLE}.bam

echo "Marking duplicates (Trimmomatic)..."
picard MarkDuplicates \
    I=alignments/mtb/trimmomatic/bam/${SAMPLE}.sorted.bam \
    O=$TRIM_BAM \
    M=alignments/mtb/trimmomatic/bam/${SAMPLE}_dup_metrics.txt \
    REMOVE_DUPLICATES=true

samtools index $TRIM_BAM

"Alignment completed!"
